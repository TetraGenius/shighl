<html>
<script src="./window/shighl.bundle.js"> </script>
<body onload="init()">
  <ul id="instances_liste"> Please Wait a moment while loading publicTypeIndex instances</ul>
  <br>
  LongChat Details : <span id="info"></span>
  <br>
  <br>
  <ul id="messages_liste"></ul>
  <br><br>
  You must open a LongChat instance & be logged to be able to post<br>
  Session : <span id="info"></span>
  <button id="login_btn" onclick="session.login()">Login</button>
  <button id="logout_btn" onclick="session.logout()">Logout</button>
  <br> <br>
  <input id="replyTo" placeholder="ReplyTo" value=""  size="100"/><br>
  <input id="inbox" placeholder="Inbox" value=""  size="100"/><br>
  <textarea id="message_content" row=10></textarea>
  <button onclick="sendChatMessage()">Send message</button>
  <br><br>
  <input id="chat_input" placeholder="Chat name"/>
  <button  onclick="pti.create()">Create LongChat Instance (todo)</button>
  <br>
  Messages dump : <span id="messages_dump"></span>
  <br>
  <a href="https://github.com/scenaristeur/shighl" target="_blank">Source</a>
  <br>
  <a href="index.html">Back to index</a>
  <script>
  let sh = new Shighl()
  console.log(sh)
  let pod = new sh.pod()
  pod.webId = "https://spoggy.solid.community/profile/card#me"
  let session = new sh.session()
  let pti, chat, webId

  function mycallback(_webId){
    webId = _webId
    console.log("WebId: ",webId)
    if (webId != null){
      info.innerHTML = webId
      login_btn.style.display = "none"
      logout_btn.style.display = "block"
    }else{
      info.innerHTML = "No session look at https://solid.inrupt.com/get-a-solid-pod"
      login_btn.style.display = "block"
      logout_btn.style.display = "none"
      session.login()
    }
  }

  async function init(){
    await session.track(mycallback)
    pti = await pod.pti
    console.log("publicTypeIndex & instances: ",pti)
    instances_liste.innerHTML = ""
    messages_liste.innerHTML = ""
    for (const inst of pti.instances){
      //  console.log(inst)
      let li = document.createElement("LI")
      li.innerHTML = inst.shortClasse+": "+inst.url
      instances_liste.appendChild(li)
      var btn = document.createElement("BUTTON")
      btn.innerHTML = "open"
      btn.value = inst.url
      btn.addEventListener('click', event => {
        initInstance(inst)
      });
      li.appendChild(btn)
    }
  }

  async function initInstance(instance){
    switch(instance.shortClasse) {
      case "LongChat":
      chat = new sh.chat()
      chat.instance = instance
      let chat_details = await chat.init
      info.innerHTML = JSON.stringify(chat_details)
      let messages = await chat.messages
      messages_dump.innerHTML = JSON.stringify(messages)
      messages_liste.innerHTML = ""
      for(const message of messages){
        console.log(message)
        let li = document.createElement("LI")
        li.innerHTML = message.makername+" WROTE "+message.content+" AT "+message.date
        messages_liste.append(li)
        var btn = document.createElement("BUTTON")
        btn.innerHTML = "reply"
        btn.addEventListener('click', event => {
          reply(message)
        });
        li.appendChild(btn)
      }

      //  updateCalendar(instance)
      break;
      case "TextDigitalDocument":
      case "MediaObject":
      case "Bookmark":
      case "Meeting":
      default:
      alert("For the moment , only LongChat")
      //  instance = await sh.initInstance(instance)
      //  updateDefault(instance)
    }
  }

  async function sendChatMessage(){
    var content = document.getElementById("message_content").value.trim()
    var replyTo = document.getElementById("replyTo").value.trim()
    var inbox = document.getElementById("inbox").value.trim()
    var postType = "InstantMessage" //"Question" // "InstantMessage" Poll...
    //  console.log(webId)
    if (webId == null ){
      webId = await session.login()
    }
    if (chat == null ){
      alert ("you must first open a LongChat instance ")
    }else{
      let mess = {content: content, webId: webId, postType: postType, replyTo: replyTo}
      console.log(mess)
      chat.message = mess


      if( inbox.length > 0){
        console.log("sended")
        let lastPost = chat.lastPost
        console.log(lastPost)
        let notif = {inbox: inbox, sender: webId, title:"solidarity reply", url:lastPost, content: lastPost+" is a "+postType+" reply to' "+replyTo,
        replyTo: replyTo}
        let recipient_pod = new sh.pod()
        let recipient_inbox = recipient_pod.inbox
        recipient_inbox.message = notif
      }
      document.getElementById("message_content").value = ""
      document.getElementById("replyTo").value = ""
      document.getElementById("inbox").value = ""
      //      initInstance(chat.instance)
      console.log("A virer une fois les websockets en place")
    }
    //  if (currentInstance.url != undefined){


    //  }else{
    //  alert("I can't post a message if there is not instance selected !")
    //}



  }

  async function reply(message){
    console.log(message)
    document.getElementById("replyTo").value = message.url

    let maker_pod =  new sh.pod()
    maker_pod.webId = message.maker
    document.getElementById("inbox").value = await maker_pod.inbox
  }



</script>
</body>

</html>
