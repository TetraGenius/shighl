<html>
<script src="./vendor/solid-auth-client.bundle.js"></script>
<script src="./vendor/solid-query-ldflex.bundle.js"></script>
<script src="./window/shighl.bundle.js"></script>

<script>

let sh, pod, session,  activity, name, friends, inbox, storage, pti
sh = new Shighl()
session = new sh.session()

async function mycallback(webId){
  console.log("WebId: ",webId)
  if (webId != null){
    logged(webId)
  }else{
    session.login()
  }
}

async function init(){
  pod = new sh.pod()
  activity = new sh.activity()
  console.log(activity)
  await session.track(mycallback)
}

async function logged(webId){
  pod.webId = webId
  name = await pod.name
  console.log("POD", pod)
  friends = await pod.friends
  inbox = await pod.inbox
  storage = await pod.storage
  pti = await pod.pti
  console.log(pod.webId)
  console.log("Name: ", name)
  console.log("Friends: ", friends)
  console.log("Inbox: ", inbox)
  console.log("Storage: ", storage)
  console.log("PTI: ", pti)
  document.getElementById("root-folder").value = storage+"public/shighl_test/"
  rootFolderInput()


  document.getElementById("radio-everyone").checked = true
  document.getElementById("recipient-input").value = "Everyone"

  let friends_ul = document.getElementById("friends-liste")

  let x = document.createElement("OPTION")
  x.setAttribute("value","");
  var t = document.createTextNode("Select a friend");
  x.appendChild(t);
  friends_ul.appendChild(x);


  friends.forEach((f, i) => {
    let x = document.createElement("OPTION")
    x.setAttribute("value", f.webId);
    var t = document.createTextNode(f.webId);
    x.appendChild(t);
    friends_ul.appendChild(x);
  });


}

async function createFolders(){
  let rf = document.getElementById("root-folder").value.trim()
  rf = rf.endsWith("/") ? rf : rf+"/";
  activity.testacl(pod, rf)
  document.getElementById("link-folder").href = rf
  document.getElementById("link-folder").innerHTML = rf
}

function sendNote(){
  var radios = document.getElementsByName('to-radio');
  var valeur;
  for(var i = 0; i < radios.length; i++){
    if(radios[i].checked){
      valeur = radios[i].value;
    }
  }
  console.log(valeur)
  let recipient = ""
  if (valeur == "friends"){
    recipient = document.getElementById("friends-liste").value.trim()
  }else{
    recipient = document.getElementById("recipient-input").value.trim()
  }
  console.log("RECIPIENT", recipient)

  /*  let example_activity = {
  "@context": "https://www.w3.org/ns/activitystreams",
  "summary": "Sally created a note",
  "type": "Create",
  "actor": {
  "type": "Person",
  "name": "Sally"
},
"object": {
"type": "Note",
"name": "A Simple Note",
"content": "This is a simple note"
}
}*/

let test_activity = {
  "@context": "https://www.w3.org/ns/activitystreams",
  "summary": name+" created a note",
  "type": "Create",
  "target": recipient,
  /*
  "target": {
  "type": "Person",
  "name": "John"
}*/
"actor": {
  "type": "Person",
  "name": name,
  "id": pod.webId
},
"object": {
  "type": "Note",
  "name": document.getElementById("note-title").value.trim(),
  "content": document.getElementById("note-content").value.trim()
}
}

if (recipient.length > 0){
  activity.create = test_activity
  document.getElementById("note-title").value=""
  document.getElementById("note-content").value=""
}else{
  alert ("You must define a Recipient to your Note !")
}
//activity.create = example_activity

}

function rootFolderInput(){
  let rf = document.getElementById("root-folder").value.trim()
  rf = rf.endsWith("/") ? rf : rf+"/";
  console.log(rf)
  document.getElementById("inbox-folder").innerHTML = rf+"inbox/"
  document.getElementById("outbox-folder").innerHTML = rf+"outbox/"
}

function check(e){
  let checked = e.getAttribute("id")
  console.log(checked)
  if (checked == "radio-everyone"){
    document.getElementById("recipient-input").value = "Everyone"
    document.getElementById("friends-liste").style.display= "none"
    document.getElementById("recipient-input").style.display = "block"
  }else if(checked == "radio-friend"){
    document.getElementById("recipient-input").style.display = "none"
    document.getElementById("friends-liste").style.display= "block"
  }
  else{
    document.getElementById("recipient-input").value = ""
    document.getElementById("friends-liste").style.display= "none"
    document.getElementById("recipient-input").style.display = "block"

  }


  //console.log(e.target.getAttribute("id"))
}

async function friendTest(e){
  let f_webId = e.value
  console.log(f_webId)
  if (e.value.length == 0){ return}
  console.log("Check inbox of ",f_webId)
  let f_pod = new sh.pod()
  f_pod.webId = f_webId
  let f_inbox = await f_pod.inbox
  let f_storage = await f_pod.storage
  let f_pti = await f_pod.pti
  console.log(f_inbox,f_storage,f_pti)


}

</script>

<body onload="init()">

  if your are not logged, use <a href="./session.html"> Shighl-Session</a> first.

  <fieldset>
    <legend>App folder create</legend>
    <input id="root-folder" oninput="rootFolderInput()" size="100"></input>
    <ul>
      <li>Inbox Folder : <span id="inbox-folder"></span> | <span id="indox-auth">AUTHENTICATED Agent Append (to receive notifications)</span></li>
      <li>Outbox Folder :<span id="outbox-folder"></span> | <span id="outbox-auth">AUTHENTICATED Agent Read (so other can see your activities)</span></li>
    </ul>

    <button onclick="createFolders()">Use those folders</button>
    <a href="" id="link-folder" target="_blank"></a>

  </fieldset>



  <fieldset>
    <legend>Send a note</legend>

    <fieldset>
      <legend>To</legend>
      <div class="some-class">
        <input type="radio"
        onchange="check(this)" class="radio" name="to-radio" value="everyone" id="radio-everyone" />
        <label for="radio-everyone">Everyone Public / on Agora POD</label>
        <input type="radio" onchange="check(this)" class="radio" name="to-radio" value="friends" id="radio-friend" />
        <label for="radio-friend">A friend</label>
        <input type="radio" onchange="check(this)" class="radio" name="to-radio" value="other" id="radio-other" />
        <label for="radio-other">Another WebId</label>
      </div>


    </fieldset>

    <br>
    <label for="recipient-input">Recipient</label>
    <input type="text" value="Everyone" id="recipient-input" />
    <select id="friends-liste" style="display:none" onchange="friendTest(this)"></select>
    <br>

    <input id="note-title" placeholder="Title" size="100"></input><br>
    <textarea id="note-content"placeholder="Content" cols="76" rows="7"></textarea><br>
    <button onclick="sendNote()">Send a Note</button>
  </fieldset>
  Look the web console to see more (Ctrl+Maj+i)<br><br>
  <a href="https://github.com/scenaristeur/shighl" target="_blank">Source</a>
  <br>
  <a href="index.html">Back to index</a>
</body>

</html>
